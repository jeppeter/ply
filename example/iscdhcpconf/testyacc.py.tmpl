#! /usr/bin/env python

import sys
import os
import importlib
import extargsparse
import logging

def _insert_path(path,*args):
    _curdir = os.path.join(path,*args)
    if _curdir  in sys.path:
        sys.path.remove(_curdir)
    sys.path.insert(0,_curdir)
    return

_insert_path(os.path.dirname(os.path.realpath(__file__)))
_insert_path(os.path.dirname(os.path.realpath(__file__)),'..','..')

import ply.yacc as yacc
import ply.lex as lex
import testlex as dlex
import dhcpconf
from cmnfile import read_file,set_logging,write_file

class ConfigDhcpYacc(object):pass

class DhcpConfYacc(ConfigDhcpYacc):
    tokens = dlex.DhcpConfLex.tokens
    def __init__(self,lexer=None):
        super(DhcpConfYacc,self).__init__(lexer)
        return

    def format_config(self):
        s = ''
        if self.statements is not None:
            #logging.info('statements %s'%(repr(self.statements)))
            s += self.statements.format_config()
        return s


    def p_error(self,p):
        if isinstance(p,object) and isinstance(p,lex.LexToken):
            pass
        raise Exception('error handle %s'%(repr(p)))

    def build(self,**kwargs):
        return yacc.yacc(module=self,start='statements',**kwargs)


def read_file(infile=None):
    fin = sys.stdin
    if infile is not None:
        logging.info('infile %s'%(infile))
        fin = open(infile,'r')
    bmode = False
    if 'b' in fin.mode:
        bmode = True
    s = ''
    for l in fin:
        if sys.version[0] == '2' or not bmode:
            s += l
        else:
            s += l.decode(encoding='UTF-8')
    if fin != sys.stdin:
        fin.close()
    fin = None
    return s



def config_handler(args,parser):
    set_logging(args)
    #if args.verbose >= 3:
    #    yacc.yaccdevel = True
    s = read_file(args.input)
    dhcplex = dlex.DhcpConfLex()
    lexer = dhcplex.build()
    dhcpyacc = DhcpConfYacc(lexer)
    parser = dhcpyacc.build(tabmodule='testparse')
    parser.parse(s)
    s = dhcpyacc.format_config()
    logging.info('%s'%(repr(dhcpyacc.statements)))
    sys.stdout.write('%s'%(s))
    sys.exit(0)
    return

def parse_dhcpconf(inputfile):
    s = read_file(inputfile)
    dhcplex = dlex.DhcpConfLex()
    lexer = dhcplex.build()
    dhcpyacc = DhcpConfYacc(lexer)
    parser = dhcpyacc.build(tabmodule='testparse')
    parser.parse(s)
    return dhcpyacc

def get_host_statements(statements):
    retdict = dict()
    if isinstance(statements,object):
        logging.info('statements [%s]'%(statements.__class__.__name__))
        if issubclass(statements.__class__,dhcpconf.HostStatement) and \
            statements.hostname is not None:
            hostname = statements.hostname.value_format()
            retdict[hostname] = statements
            return retdict
        for c in statements.children:
            retdict.update(get_host_statements(c))
    return retdict

def get_hardware_statements(statements):
    retarr = []
    if isinstance(statements,object):
        if issubclass(statements.__class__,dhcpconf.HardwareStatement):
            retarr.append(statements)
            return retarr
        for c in statements.children:
            retarr.extend(get_hardware_statements(c))
    return retarr

def get_fixed_address(statements):
    retarr = []
    if isinstance(statements,object):
        if issubclass(statements.__class__,dhcpconf.FixedAddressDeclaration) and \
            statements.fixedaddress is not None:
            retarr.append(statements)
            return retarr
        for c in statements.children:
            retarr.extend(get_fixed_address(c))
    return retarr


def addhost_handler(args,parser):
    set_logging(args)
    if args.macaddr is None or \
        args.ipaddr is None or \
        args.hostname is None:
        raise Exception('must specified macaddr[--macaddr|-m] hostname[--hostname|-H] ipaddr[--ipaddr|-I]')
    dhcpyacc = parse_dhcpconf(args.input)
    statements = dhcpyacc.statements
    if statements is None:
        raise Exception('no statements adding')
    children = statements.get_child('HostStatement',True)
    findone = None
    for c in children:
        macs = c.get_child('HardwareDeclaration',True)
        if len(macs) > 0:
            for m in macs:
                if m.hard_type.value_format() == 'ethernet' and \
                    m.hard_addr.value_format() == args.macaddr:
                    findone = c
    if findone is not None:
        ips = findone.get_child('FixedAddressDeclaration',True)
        if len(ips) > 0:
            ips[0].fixedaddress = args.ipaddr
        else:
            ipchild = dhcpconf.FixedAddressDeclaration(args.ipaddr)
            findone.append_child(ipchild)
    else:
        appv = dhcpconf.HostStatement()
        hostname = dhcpconf.HostName()
        hostname.hostname = args.hostname
        appv.set_hostname(hostname)
        hostname = None
        hardtype = dhcpconf.HardwareType('ethernet')
        hardaddr = dhcpconf.HardwareAddr()
        hardaddr.hardwareaddr = args.macaddr
        decl = dhcpconf.HardwareStatement()
        decl.set_type(hardtype)
        decl.set_addr(hardaddr)
        fixaddr = dhcpconf.FixedAddressDeclaration()
        fixaddr.fixedaddress = args.ipaddr
        hostdecl = dhcpconf.HostDeclaration()
        hostdecl.append_child(decl)
        hostdecls = dhcpconf.HostDeclarations()
        hostdecls.append_child(hostdecl)
        hostdecl = dhcpconf.HostDeclaration()
        hostdecl.append_child(fixaddr)
        hostdecls.append_child(hostdecl)
        appv.append_child(hostdecls)
        logging.info('%s'%(repr(appv)))
        statements.append_child(appv)
    logging.info('%s'%(repr(statements)))
    s = statements.format_config(0)
    write_file(s,args.output)
    sys.exit(0)
    return



def listhost_handler(args,parser):
    set_logging(args)
    dhcpyacc = parse_dhcpconf(args.input)
    hostdict = get_host_statements(dhcpyacc.statements)
    outs = ''
    for k in hostdict.keys():
        s = '%s'%(k)
        retarr = get_hardware_statements(hostdict[k])
        if len(retarr) > 0:
            if retarr[0].hard_type is not None:
                s += ',%s'%(retarr[0].hard_type.value_format())
            if retarr[0].hard_addr is not None:
                s += ',%s'%(retarr[0].hard_addr.value_format())
            outs += s
            outs += '\n'
    write_file(outs,args.output)
    sys.exit(0)
    return


def main():
    command='''
    {
        "verbose|v" : "+",
        "input|i" : null,
        "macaddr|m" : null,
        "ipaddr|I" : null,
        "hostname|H" : null,
        "config<config_handler>" : {
            "$" : 0
        },
        "addhost<addhost_handler>" : {
            "$" : 0
        },
        "listhost<listhost_handler>" : {
            "$" : "*"
        }
    }
    '''
    parser = extargsparse.ExtArgsParse()
    parser.load_command_line_string(command)
    args = parser.parse_command_line()
    return

if __name__ == '__main__':
    main()

